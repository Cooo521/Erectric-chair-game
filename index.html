<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>電気椅子ゲーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes electric {
            0%, 100% { opacity: 1; transform: scale(1); filter: brightness(1); }
            50% { opacity: 0.7; transform: scale(1.1); filter: brightness(1.5) contrast(1.2); }
        }
        @keyframes electric-bg {
            0%, 100% { background-color: rgba(250, 204, 21, 1); }
            50% { background-color: rgba(0, 0, 0, 1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        @keyframes glow-red {
            0%, 100% { box-shadow: 0 0 10px rgba(220, 38, 38, 0.5); border-color: #ef4444; }
            50% { box-shadow: 0 0 30px rgba(220, 38, 38, 1); border-color: #f87171; }
        }
        .animate-electric { animation: electric 0.05s linear infinite; }
        .animate-electric-bg { animation: electric-bg 0.1s step-end infinite; }
        .animate-shake { animation: shake 0.1s ease-in-out infinite; }
        .animate-glow-red { animation: glow-red 0.6s ease-in-out infinite; }
        
        /* スマホのアドレスバーなどを考慮した高さ設定 */
        .dynamic-screen {
            min-height: 100vh;
            min-height: 100dvh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .chair-container {
            position: relative;
            height: 18rem; /* 72 units */
            display: flex;
            align-items: center;
            justify-content: center;
            /* 画面が小さい時に縮小するように調整 */
            max-width: 100%;
            transform: scale(min(1, 80vw / 300px));
        }
        @media (max-height: 600px) {
            .chair-container {
                height: 14rem;
                transform: scale(0.8);
            }
        }

        .chair {
            position: absolute;
            width: 3rem;
            height: 3rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-weight: bold;
            border-width: 2px;
        }
        .body-electric-bg {
            transition: background-color 0.075s;
        }
        
        /* スクロールを防止しつつ、コンテンツが溢れた場合のみスクロール可能に */
        html, body {
            overflow: hidden;
            height: 100%;
        }
    </style>
</head>
<body class="bg-neutral-900 text-white flex flex-col items-center justify-center font-sans select-none body-electric-bg dynamic-screen" id="body-root">

    <div id="game-container" class="max-w-md w-full h-full max-h-[90dvh] overflow-y-auto rounded-3xl shadow-2xl p-6 sm:p-8 border relative transition-colors bg-neutral-800 border-neutral-700 flex flex-col justify-center">
        <!-- コンテンツがJavaScriptによって動的に挿入されます -->
    </div>

    <script>
        // --- 状態管理 ---
        let gameState = 'START';
        let players = [
            { id: 1, name: 'プレイヤー1', score: 0, outs: 0 },
            { id: 2, name: 'プレイヤー2', score: 0, outs: 0 },
        ];
        let setterIndex = 0;
        let availableChairs = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
        let selectedTrap = null;
        let selectedSit = null;
        let lastResult = null;
        let autoTransitionTimer = null;
        const WINNING_SCORE = 40;

        const container = document.getElementById('game-container');
        const bodyRoot = document.getElementById('body-root');

        // --- アイコン (SVG) ---
        const icons = {
            zap: (colorClass) => `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${colorClass}"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
            zapLarge: (colorClass) => `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${colorClass}"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
            power: () => `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10"/><path d="M18.4 6.6a9 9 0 1 1-12.8 0"/></svg>`,
            trophy: () => `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            user: () => `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
            rotate: () => `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>`
        };

        // --- ヘルパー関数 ---
        function renderOuts(count) {
            let html = '<div class="flex gap-1 mt-1 justify-center">';
            for (let i = 0; i < 3; i++) {
                const color = i < count ? 'text-yellow-400 fill-yellow-400' : 'text-neutral-600';
                html += icons.zap(color);
            }
            html += '</div>';
            return html;
        }

        function getChairStyle(num) {
            const angle = (num * 30 - 90) * (Math.PI / 180);
            const radius = 120;
            const x = Math.cos(angle) * radius;
            const y = Math.sin(angle) * radius;
            return `transform: translate(${x}px, ${y}px);`;
        }

        // --- アクション ---
        function setTrap(num) {
            selectedTrap = num;
            render();
        }

        function selectSit(num) {
            selectedSit = num;
            render();
        }

        function judge() {
            const sitterIndex = 1 - setterIndex;
            const isHit = selectedSit === selectedTrap;
            
            if (isHit) {
                players[sitterIndex].score = 0;
                players[sitterIndex].outs += 1;
                lastResult = { success: false, points: 0, hitNum: selectedSit };
                
                // アウト時は3秒後に自動遷移
                autoTransitionTimer = setTimeout(() => {
                    if (gameState === 'RESULT') checkGameOver();
                }, 3000);
            } else {
                players[sitterIndex].score += selectedSit;
                lastResult = { success: true, points: selectedSit, hitNum: selectedSit };
                availableChairs = availableChairs.filter(c => c !== selectedSit);
            }
            gameState = 'RESULT';
            render();
        }

        // --- レンダリングエンジン ---
        function render() {
            const sitterIndex = 1 - setterIndex;

            // 背景とコンテナのクラス制御（電流演出）
            if (gameState === 'RESULT' && !lastResult.success) {
                bodyRoot.className = 'bg-neutral-900 flex flex-col items-center justify-center font-sans select-none animate-electric-bg dynamic-screen';
                container.className = 'max-w-md w-full h-full max-h-[90dvh] overflow-y-auto rounded-3xl shadow-2xl p-6 sm:p-8 border relative bg-black/90 border-yellow-500 shadow-yellow-500/50 animate-shake flex flex-col justify-center';
            } else {
                bodyRoot.className = 'bg-neutral-900 text-white flex flex-col items-center justify-center font-sans select-none body-electric-bg dynamic-screen';
                container.className = 'max-w-md w-full h-full max-h-[90dvh] overflow-y-auto rounded-3xl shadow-2xl p-6 sm:p-8 border relative transition-colors bg-neutral-800 border-neutral-700 flex flex-col justify-center';
            }

            let html = '';

            // ヘッダー表示
            if (gameState !== 'START' && gameState !== 'GAME_OVER') {
                html += `
                <div class="flex justify-between items-start mb-6 border-b border-neutral-700 pb-4">
                    <div class="p-2 rounded-lg text-center ${setterIndex === 0 ? 'bg-red-900/40 text-red-400' : 'bg-blue-900/40 text-blue-400'}">
                        <span class="text-[10px] block uppercase opacity-70">Setter</span>
                        <span class="font-bold text-sm">${players[setterIndex].name}</span>
                        ${renderOuts(players[setterIndex].outs)}
                    </div>
                    <div class="text-center pt-2">
                        <span class="text-[10px] block opacity-70 uppercase tracking-tighter">Remaining</span>
                        <span class="text-lg font-mono">${availableChairs.length}</span>
                    </div>
                    <div class="p-2 rounded-lg text-center ${sitterIndex === 0 ? 'bg-red-900/40 text-red-400' : 'bg-blue-900/40 text-blue-400'}">
                        <span class="text-[10px] block uppercase opacity-70">Sitter</span>
                        <span class="font-bold text-sm">${players[sitterIndex].name}</span>
                        ${renderOuts(players[sitterIndex].outs)}
                    </div>
                </div>`;
            }

            switch(gameState) {
                case 'START':
                    html = `
                    <div class="text-center py-8">
                        <div class="mb-6 flex justify-center">
                            <div class="bg-yellow-500 p-4 rounded-full animate-pulse shadow-[0_0_30px_rgba(234,179,8,0.5)]">
                                ${icons.zapLarge('text-neutral-900 fill-neutral-900')}
                            </div>
                        </div>
                        <p class="text-neutral-400 text-xs sm:text-sm mb-1 uppercase tracking-tighter">水曜日のダウンタウンでおなじみの</p>
                        <h1 class="text-4xl font-black mb-2 tracking-tighter italic text-yellow-500 leading-none">電気イスゲーム</h1>
                        <p class="text-neutral-400 mb-8 mt-4 text-sm">3アウトで即終了、もしくは<br><span class="text-white font-bold">${WINNING_SCORE}点先取</span>で勝利</p>
                        <button onclick="gameState='SETTER_TURN'; render();" class="w-full sm:w-auto px-12 py-4 font-bold text-white bg-red-600 rounded-xl hover:bg-red-500 transition-all shadow-lg active:scale-95">GAME START</button>
                    </div>`;
                    break;

                case 'SETTER_TURN':
                    html += `
                    <div class="text-center">
                        <h2 class="text-xl font-bold mb-1 text-red-500 underline underline-offset-4 decoration-2">仕掛ける側：${players[setterIndex].name}</h2>
                        <p class="text-[10px] text-neutral-400 mb-6">電流を流す椅子を1つ選んでください</p>
                        <div class="flex justify-center">
                            <div class="chair-container">
                                ${[1,2,3,4,5,6,7,8,9,10,11,12].map(num => {
                                    const isAvailable = availableChairs.includes(num);
                                    const isSelected = selectedTrap === num;
                                    return `<button onclick="setTrap(${num})" ${!isAvailable ? 'disabled' : ''} style="${getChairStyle(num)}" 
                                        class="chair ${!isAvailable ? 'border-neutral-700 bg-neutral-900 text-neutral-700 cursor-not-allowed' : 
                                        isSelected ? 'border-red-500 bg-red-600 text-white scale-125 z-10 shadow-lg shadow-red-500/50' : 'border-neutral-600 hover:border-red-400 text-neutral-400'} active:scale-110">
                                        ${num}
                                    </button>`;
                                }).join('')}
                                <div class="text-neutral-600 opacity-20">${icons.zapLarge('')}</div>
                            </div>
                        </div>
                        <button onclick="if(selectedTrap){gameState='SITTER_TURN'; render();}" ${!selectedTrap ? 'disabled' : ''} 
                            class="mt-6 w-full py-4 rounded-xl font-bold transition-all ${selectedTrap ? 'bg-white text-black hover:bg-neutral-200 shadow-lg active:scale-95' : 'bg-neutral-700 text-neutral-500'}">
                            決定して交代
                        </button>
                    </div>`;
                    break;

                case 'SITTER_TURN':
                    html += `
                    <div class="text-center">
                        <h2 class="text-xl font-bold mb-1 text-blue-400 underline underline-offset-4 decoration-2">座る側：${players[sitterIndex].name}</h2>
                        <p class="text-[10px] text-neutral-400 mb-6">どの椅子に座りますか？</p>
                        <div class="flex justify-center">
                            <div class="chair-container">
                                ${[1,2,3,4,5,6,7,8,9,10,11,12].map(num => {
                                    const isAvailable = availableChairs.includes(num);
                                    const isSelected = selectedSit === num;
                                    return `<button onclick="selectSit(${num})" ${!isAvailable ? 'disabled' : ''} style="${getChairStyle(num)}" 
                                        class="chair ${!isAvailable ? 'border-neutral-700 bg-neutral-900 text-neutral-700 cursor-not-allowed' : 
                                        isSelected ? 'border-blue-500 bg-blue-600 text-white scale-125 z-10 shadow-lg shadow-blue-500/50' : 'border-neutral-600 hover:border-blue-400 text-neutral-400'} active:scale-110">
                                        ${num}
                                    </button>`;
                                }).join('')}
                                <div class="text-neutral-600 opacity-20">${icons.user()}</div>
                            </div>
                        </div>
                        <button onclick="if(selectedSit){judge();}" ${!selectedSit ? 'disabled' : ''} 
                            class="mt-6 w-full py-4 rounded-xl font-black text-xl transition-all ${selectedSit ? 'bg-red-600 text-white hover:bg-red-500 animate-pulse shadow-xl shadow-red-600/50 active:scale-95' : 'bg-neutral-700 text-neutral-500'}">
                            ファイナルアンサー？
                        </button>
                    </div>`;
                    break;

                case 'RESULT':
                    if (lastResult.success) {
                        html += `
                        <div class="text-center">
                            <h2 class="text-xl font-bold mb-1 text-green-400">判定：SAFE</h2>
                            <p class="text-[10px] text-neutral-400 mb-6">${lastResult.hitNum}番に電流は流れていませんでした</p>
                            
                            <div class="flex justify-center">
                                <div class="chair-container">
                                    ${[1,2,3,4,5,6,7,8,9,10,11,12].map(num => {
                                        const isAvailable = availableChairs.includes(num) || num === lastResult.hitNum;
                                        const isSit = lastResult.hitNum === num;
                                        const isTrap = selectedTrap === num;
                                        
                                        let extraClasses = 'border-neutral-700 bg-neutral-900 text-neutral-700';
                                        if (isSit) extraClasses = 'border-blue-500 bg-blue-600 text-white scale-110 z-10';
                                        if (isTrap) extraClasses = 'animate-glow-red text-red-500 scale-110 z-20';

                                        return `<div style="${getChairStyle(num)}" class="chair ${extraClasses}">${num}</div>`;
                                    }).join('')}
                                    <div class="text-green-400 font-black text-4xl italic tracking-tighter">SAFE</div>
                                </div>
                            </div>
                            
                            <div class="mt-6 bg-neutral-900/50 p-4 rounded-xl mb-4 border border-green-500/30">
                                <p class="text-green-400 font-bold">${lastResult.points} ポイント獲得！</p>
                            </div>
                            
                            <button onclick="checkGameOver()" class="w-full py-4 rounded-xl bg-white text-black font-bold hover:bg-neutral-200 transition-colors shadow-lg active:scale-95">次へ</button>
                        </div>`;
                    } else {
                        html += `
                        <div class="text-center py-4">
                            <div class="mb-6 flex justify-center">
                                <div class="bg-yellow-400 p-6 rounded-full animate-electric shadow-[0_0_50px_rgba(250,204,21,1)]">${icons.zapLarge('text-black fill-black')}</div>
                            </div>
                            <h2 class="text-6xl font-black mb-4 italic tracking-widest text-yellow-400 animate-bounce">OUT</h2>
                            <p class="text-lg mb-2 text-white">選択した番号: <span class="text-3xl font-bold">${lastResult.hitNum}</span></p>
                            <div class="bg-black/50 p-4 rounded-xl mb-6 border border-neutral-700 backdrop-blur-sm">
                                <div class="space-y-1"><p class="text-red-500 font-black text-xl tracking-tighter">⚡⚡⚡ 電流 ⚡⚡⚡</p><p class="text-white text-[10px]">全ポイント没収 ＆ 1アウト追加</p></div>
                            </div>
                            <p class="text-neutral-500 text-[10px] animate-pulse">3秒後にスコアボードへ移動します...</p>
                        </div>`;
                    }
                    break;

                case 'SCOREBOARD':
                    html += `
                    <div class="text-center">
                        <h2 class="text-2xl font-black mb-6 text-yellow-500 italic tracking-widest">SCORE BOARD</h2>
                        <div class="space-y-4 mb-8">
                            ${players.map((p, idx) => `
                                <div class="flex justify-between items-center p-4 rounded-xl border-2 transition-opacity ${idx === setterIndex ? 'border-neutral-700 opacity-40' : 'border-neutral-500 bg-neutral-900/80 shadow-inner'}">
                                    <div class="text-left">
                                        <span class="font-bold text-lg">${p.name}</span>
                                        ${renderOuts(p.outs)}
                                    </div>
                                    <div class="text-right">
                                        <div class="text-[10px] text-neutral-500 uppercase">Score</div>
                                        <span class="text-2xl font-mono font-bold text-white">${p.score} <span class="text-xs">/ ${WINNING_SCORE}</span></span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="nextTurn()" class="w-full py-4 rounded-xl bg-red-600 text-white font-bold hover:bg-red-500 transition-all flex items-center justify-center gap-2 shadow-lg shadow-red-600/30 active:scale-95">
                            役割を交代して開始 ${icons.rotate()}
                        </button>
                    </div>`;
                    break;

                case 'GAME_OVER':
                    let winnerName = 'DRAW';
                    const p1 = players[0];
                    const p2 = players[1];

                    if (p1.outs >= 3) {
                        winnerName = p2.name;
                    } else if (p2.outs >= 3) {
                        winnerName = p1.name;
                    } else if (p1.score >= WINNING_SCORE) {
                        winnerName = p1.name;
                    } else if (p2.score >= WINNING_SCORE) {
                        winnerName = p2.name;
                    } else {
                        winnerName = p1.score > p2.score ? p1.name : (p2.score > p1.score ? p2.name : 'DRAW');
                    }

                    html = `
                    <div class="text-center py-4">
                        <h2 class="text-3xl font-black mb-6 text-yellow-500 italic">GAME OVER</h2>
                        <div class="space-y-4 mb-8">
                            ${players.map(p => `
                                <div class="flex justify-between items-center p-4 rounded-xl bg-neutral-900 border ${p.outs >= 3 ? 'border-red-600 opacity-60' : 'border-neutral-700'}">
                                    <div class="text-left">
                                        <span class="font-bold">${p.name}</span>
                                        ${renderOuts(p.outs)}
                                    </div>
                                    <span class="text-2xl font-mono font-bold text-white">${p.score} pts</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="p-6 bg-yellow-500 p-1 rounded-2xl mb-8 shadow-[0_0_40px_rgba(234,179,8,0.3)]">
                            <div class="bg-neutral-900 rounded-xl py-4 px-2">
                                <p class="text-yellow-500 text-xs mb-1 uppercase tracking-[0.3em]">Winner</p>
                                <h3 class="text-3xl font-black text-white">${winnerName}</h3>
                            </div>
                        </div>
                        <button onclick="resetGame()" class="w-full py-4 rounded-xl bg-white text-black font-bold hover:bg-neutral-200 transition-colors active:scale-95">リベンジマッチ</button>
                    </div>`;
                    break;
            }

            container.innerHTML = html;
        }

        function checkGameOver() {
            if (autoTransitionTimer) clearTimeout(autoTransitionTimer);
            const isAnyPlayerDefeated = players.some(p => p.outs >= 3);
            const isAnyPlayerWonByScore = players.some(p => p.score >= WINNING_SCORE);
            
            if (isAnyPlayerDefeated || isAnyPlayerWonByScore || availableChairs.length === 0) {
                gameState = 'GAME_OVER';
            } else {
                gameState = 'SCOREBOARD';
            }
            render();
        }

        function nextTurn() {
            setterIndex = 1 - setterIndex;
            selectedTrap = null;
            selectedSit = null;
            lastResult = null;
            gameState = 'SETTER_TURN';
            render();
        }

        function resetGame() {
            players = [
                { id: 1, name: 'プレイヤー1', score: 0, outs: 0 },
                { id: 2, name: 'プレイヤー2', score: 0, outs: 0 },
            ];
            availableChairs = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            setterIndex = 0;
            selectedTrap = null;
            selectedSit = null;
            gameState = 'START';
            render();
        }

        // 初回起動
        render();
    </script>
</body>
</html>
